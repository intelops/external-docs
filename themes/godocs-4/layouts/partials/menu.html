{{ $currentNode := . }}
{{ $isSeparateChangelogPage := findRE "changelog" (index (split .RelPermalink "/") 1) }}
{{ $changelogTopics := slice }}
{{ $currentChangelogNode := site.GetPage .Section }}
{{ $currentRelPermalink := delimit (first 2 (split .RelPermalink "/")) "/" }}
{{ $currentRelChangelogPermalink := delimit (first 2 (split .RelPermalink "/")) "/" }}
{{ $currentPageVersion := index (findRE `(\d+\.\d+\.\d+)` .RelPermalink) 0 }}

{{/*  {{ range site.Sections }}
  {{ if (findRE "-changelog" .Section) }}
    {{ $changelogTopics = $changelogTopics | append .Section }}
  {{ end }}
{{ end }}
  */}}

<ul class="menu py-4 pe-4 ps-0 border-end border-default mb-0">
  {{- range (where site.Sections ".Params.Type" "==" "docs-root") }}
    <!-- For Nested Changelog & Topics -->
    {{ $latest_version := .Params.latest_version }}
    {{ range .Pages }}
      {{ $sectionNode := delimit (first 2 (split .RelPermalink "/")) "/" }}
      {{ $isChangelog := index (first 4 (split .RelPermalink "/")) 2}}
      {{ $currentRangeVersion := index (findRE `(\d+\.\d+\.\d+)` .RelPermalink) 0 }}
      {{ $currentRangeClgVersion := findRE `(\d+\.\d+\.\d+)` .RelPermalink }}

      {{ if eq $currentRelPermalink $sectionNode }}
        {{ if and (ne $isChangelog "changelog") (eq $currentPageVersion $currentRangeVersion) }}
          {{ if eq $latest_version $currentRangeVersion }}
            {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode }}
          {{ else if ne $latest_version $currentRangeVersion }}
            {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode }}
          {{ end }}
        {{ end }}

        {{ if and (eq $isChangelog "changelog") }}
          {{ $latest_version := .Params.latest_version }}
    
          {{ range .Pages }}
            {{ $sectionNode := delimit (first 2 (split .RelPermalink "/")) "/" }}
            {{ $isChangelog := index (first 4 (split .RelPermalink "/")) 2}}
            {{ $currentRangeVersion := index (findRE `(\d+\.\d+\.\d+)` .RelPermalink) 0 }}

            {{ if and (eq $isChangelog "changelog") (eq $currentPageVersion $currentRangeVersion) }}
            {{ range .Pages }}
              {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode }}
            {{ end }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{- end }}

  {{ if $isSeparateChangelogPage }}
    <!-- For Separate Changelogs -->
    {{ $changelogs := slice }}
    {{ range (where site.Pages ".Params.Type" "==" "changelog") }}
      {{ $latest_version := .Params.latest_version }}
      
      {{ if and $latest_version (eq .Params.type "changelog") }}
        {{ range .Pages }}
        {{ $currentRangeVersion := index (findRE `(\d+\.\d+\.\d+)` .RelPermalink) 0 }}
          {{ if eq $latest_version $currentRangeVersion }}
            {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode }}
          {{ end }}
        {{ end }}
      {{ end }}

    {{ end }}
  {{- end }}
</ul>

<!-- templates -->
{{- define "section-tree-nav" }}
  {{ $currentNode := .currentnode }}
  {{- with .sect }}
    {{- if .IsSection }}
      {{- $numberOfPages := (add (len .Pages) (len .Sections)) }}
      {{/* {{- safeHTML .Params.head }} */}}
      <li
        data-nav-id="{{ .Permalink }}"
        class="sidenav-item  {{ if ne $numberOfPages 0 }}haschildren{{ end }}">
        <div>
          <a href="{{ .RelPermalink }}">{{ .Title }}</a>
          {{- if ne $numberOfPages 0 }}
            <div class="category-icon">
              <i class="fa fa-angle-right fa-lg"></i>
            </div>
          {{- end }}
        </div>

        {{- if ne $numberOfPages 0 }}
          <ul>
            {{- $pages := .Pages }}
            {{- if .Sections }}
              {{- $pages = (.Pages | union .Sections) }}
            {{- end }}
            {{- range $pages.ByWeight }}
              {{- template "section-tree-nav" dict "sect" . }}
            {{- end }}
          </ul>
        {{- end }}
      </li>
    {{- end }}
  {{- end }}
{{- end }}
